<html>
    <head>
        <title>Non-standard Idea Mapping</title>
    </head>

    <style>
    #map 
    {
        height: 500px;
        width: 500px;
        border: 1px dotted;
    }
    </style>

    <body>
        <div id="map"></div>
    </body>

    <script src="kinetic.js" type="text/javascript"></script>
    <script type="text/javascript">
    var stage = new Kinetic.Stage({
        container: 'map',
        width: 500,
        height: 500
    });

    var ideaLayer = new Kinetic.Layer();
    var connectionLayer = new Kinetic.Layer();

    stage.add(ideaLayer);
    stage.add(connectionLayer);

    function redrawConnections(shapeId)
    {
        var idea = ideaLayer.get("#" + shapeId)[0];

        if (idea)
        {
            for (var i = 0 ; i < idea.ideaConnections.length ; i++)
            {
                var otherIdeaId = idea.ideaConnections[i];
                drawConnection(idea.getId(), otherIdeaId);
            }
        }
        else
        {
            alert("Error in redrawing connections: shape with id \"" + shapeId + "\" could not be found");
        }
    }

    function generateCircle(shapeId, color)
    {
        var circle = new Kinetic.Circle({
            id: shapeId,
            x: Math.random() * 300 + 50,
            y: Math.random() * 300 + 50,
            radius: 48,
            fill: color,
            stroke: 'black',
            strokeWidth: 2,
            draggable: true
        });

        circle.on("dragmove", function() { redrawConnections(shapeId); });

        return circle;
    }

    function drawConnection(shapeId1, shapeId2)
    {
        var shape1 = stage.get('#' + shapeId1)[0];
        var shape2 = stage.get('#' + shapeId2)[0];

        var shape1x = shape1.getPosition().x;
        var shape1y = shape1.getPosition().y;

        var shape2x = shape2.getPosition().x;
        var shape2y = shape2.getPosition().y;

        var line = stage.get('#' + shapeId1 + "-" + shapeId2)[0];
        if (line)
        {
            line.remove();
        }
        else
        {
            line = stage.get('#' + shapeId2 + "-" + shapeId1)[0];
            if (line)
            {
                line.remove();
            }
        }

        line = new Kinetic.Line({
            id: shapeId1 + "-" + shapeId2,
            points: [shape1x, shape1y, shape2x, shape2y],
            stroke: 'black',
            strokeWidth: 2
        });

        connectionLayer.add(line);
        connectionLayer.draw();
    }

    function addIdea(title, shape)
    {
        ideaLayer.add(shape);
        ideaLayer.draw();

        shape.ideaConnections = new Array();
        shape.ideaConnections[0] = shape.getId();

        var allIdeas = ideaLayer.getChildren();
        for (var i = 0 ; i < allIdeas.length ; i++)
        {
            var idea = allIdeas[i];

            idea.ideaConnections[idea.ideaConnections.length] = shape.getId();
            shape.ideaConnections[shape.ideaConnections.length] = idea.getId();

            drawConnection(shape.getId(), idea.getId());
        }
    }

    addIdea("Red Idea", generateCircle('red', 'red'));
    addIdea("Green Idea", generateCircle('green', 'green'));
    addIdea("Blue Idea", generateCircle('blue', 'blue'));


    alert("Loaded");
    </script>

</html>
